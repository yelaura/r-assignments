---  
title: "Assignment 2"
author: "LAURA YE; laura.ye.lin@gmail.com"  
date: "October 24, 2017"  
output: 
  html_document:  
    toc: yes  

---  

***

# Loading the Data 

Let's load the AOL Search Data Set (extracted from aol_search_data.zip):

```{r, echo=TRUE, comment=NA, warning=FALSE, message=FALSE, }
library(tidyverse)
setwd("C:\\Users\\lye\\Downloads\\aol_search_data")
user_searches <- read_tsv("user_searches.txt")
```

# Cleaning the Data

## Tranforming column names to snake case

See how the current column names look like:

```{r, echo=TRUE, comment=NA, warning=FALSE, message=FALSE, }
names(user_searches)
```

Function for transforming a string to snake case

```{r, echo=TRUE, comment=NA, warning=FALSE, message=FALSE, }
snake_case <- function (x) {
  s <- gsub("\\.", "_", x) # Replace dots with underscores
  s <- gsub("(.)([A-Z][a-z]+)", "\\1_\\2", s) # Separate with underscores on capitalization
  s <- tolower(gsub("([a-z0-9])([A-Z])", "\\1_\\2", s)) #lowercase
  s <- gsub("__", "_", s) #double to single underscore
  s <- gsub("^[_, .]", "", s) # del first char underscore "_" or period "."
  s <- gsub(' ', '', s) # remove spaces
}
```

Function for converting data frame result column names to snake case
```{r, echo=TRUE, comment=NA, warning=FALSE, message=FALSE, }
fix_column_names <- function(x) {
  names(x) <- snake_case(names(x))
  return(x)
}

user_searches <- user_searches %>%
  fix_column_names
```

Check that the column names have been transformed:

```{r, echo=TRUE, comment=NA, warning=FALSE, message=FALSE, }
names(user_searches)
```

# Analyzing the Data

## Group the data by "user session"

A "user session" is defined by all events for a given user where there is no more than a thirty minute gap between events. 

First, determine which rows belong to which sessions.

```{r, echo=TRUE, comment=NA, warning=FALSE, message=FALSE, }
sessions <- user_searches %>%
  arrange(anon_id, query_time) %>%
  group_by(anon_id) %>%
  mutate(
    time_diff = difftime(query_time, lag(query_time), units="min"),
    new_session = is.na(lag(anon_id)) | (time_diff > 30),
    session_sequence_number = cumsum(as.numeric(new_session)),
    session_id = paste(anon_id, "_", session_sequence_number, sep="")
  ) %>%
  glimpse
```

Now that we have the each query broken assigned to a unique session ID per user, we can summarize its statistics and gather data like number of searches, when the session started, when the session ended, session duration, number of clicks, mean rank of query, and mean number of search terms (separated by " ").

```{r, echo=TRUE, comment=NA, warning=FALSE, message=FALSE, }
sessions_stats <- sessions %>%
  group_by(anon_id, session_sequence_number) %>%
  summarise(
    number_searches = n(),
    session_started_at = first(query_time),
    session_ended_at = last(query_time),
    session_length = difftime(session_ended_at, session_started_at, unit="mins"),
    number_clicks = sum(!is.na(click_url)),
    mean_item_rank = mean(item_rank),
    mean_number_search_terms = mean(length(strsplit(query, " ")))
  ) %>%
  glimpse
```

# Plotting the session statistics

## Statistics by session

Distribution of session durations (histogram count)

Distribution of the number of clicks per session (histogram count)

## Statistics by user

Distribution of the number of sessions by user (histogram count)

Distribution of the mean session duration by user (histogram count)

## Statistics by query_time

Distribution of the number of queries during a certain time of day

Distribution of the number of clicks during a certain time of day

Distribution of number of sessions during a certain time of day


